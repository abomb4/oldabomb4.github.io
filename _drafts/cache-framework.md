---
layout: post
title:  "缓存框架需求与设计"
categories: Java
date: +0800 2018-02-24 15:13:00
tag: java cache redis ehcache
---

* content
{:toc}

# 简介
--------------
缓存是一种放在请求方与数据源之间的存储机制，它对调用方提供比原数据源更快的速度。

缓存是一个比较通用的课题，在较大的项目中，我们对缓存系统的要求会越来越高，
包括但不限于存取数据、缓存过期机制、缓存手动管理等特性。

这里记录一些关于我们常用的缓存框架的功能需求，与缓存框架的设计思路。

# 名词定义
---------------
- 缓存框架：提供给Java应用程序使用，用于操作缓存的开发框架
- 缓存产品：缓存的具体实现，比如`EhCache`、`Redis`、`Memcache`

# 缓存需求
--------------
在Java中，我们将缓存抽象为`<String, Object>`类型即可，这样可以支持多种数据存储，也
避免`<Object, Object>`类型中key的复杂度。

无论在项目的什么阶段，我们对缓存总是有很多需求的，而不单单是简单的存取刷新。

基本的功能需求包括：
1. 按key保存（覆盖保存）
1. 按key读取
1. 按key消除
1. 缓存分组
1. 按分组消除
1. 更改缓存产品

扩展的功能需求包括：
1. 设置缓存过期策略
1. 缓存监控与统计
1. 二级缓存

## 按key保存、读取、消除
----------------
这是所有缓存系统必须拥有的功能。
正常情况我们只需要保存功能（覆盖保存）和读取功能即可。

缓存清除按key删除功能一般在缓存的数据不正常时会使用，其余情况使用不多。

而非覆盖保存我们大多数情况下不会需要。

## 缓存分组、按分组消除
-----------------
缓存分组功能一般用于批量清空缓存。比如用户数据在数据库正面发生数据迁移或更新，
没有经过应用系统，造成缓存中的用户数据都不正常了，此时可以把“用户”分组的缓存都清空。

如果没有分组功能，则我们需要一个“条件清空”功能，或“全部清空”的功能来满足需求。

使用条件清空功能，当想要清空某类数据时，删除所有`groupName_key`的值。

不过这些功能可以不在应用系统中使用，在缓存管理系统中存在即可。

## 更改缓存后端
-------------
这是一个对缓存框架的需求，因为我们有朝一日可能会将系统中`Redis`缓存统一更改成`Couchbase`或`Memcache`。

这种切换不应该对应用系统的现有代码造成大量改动。

## 设置缓存过期策略
--------------
目前我能想到有几种策略需求：
1. 过期策略
1. 缓存大小限制

**过期策略** 可能我们有些数据的改动略频繁，让它早点过期；不频繁的不过期之类的。
**缓存大小限制** 这个需求用在JVM缓存上，比如`EhCache`。当缓存过大，我们则需要行驶删除策略，如
“将最大的缓存数据删掉”，或“将最旧的缓存删掉”，或其他什么逻辑来释放缓存空间。
主要用来防止JVM缓存过大导致堆内存不足。

## 监控与统计
---------------
监控与统计分为两个部分。
- 一部分在缓存框架上面，记录单个应用对缓存的操作记录。
- 另一部分在缓存产品上，对整体缓存情况做一个完整统计。

缓存框架上的监控与统计，对于排查应用与缓存之间的问题很有帮助，
例如每次从`Redis`上取数据的耗时和从`MySQL`上查数据的时长差不多，那么我们就要考虑缓存的必要性了。
